<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 3: All-Nighter Lab - The Final Race</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
            background-color: #f8fafc; /* Base color */
            transition: background-color 1.5s ease; /* Drastic color transition */
        }
        
        /* Base Colors (from level2.html) */
        .custom-red {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        .text-custom-red {
            color: #dc2626;
        }
        
        .custom-gold {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        /* Flashcard Styles */
        .flip-card {
            perspective: 1000px;
            width: 100%;
            height: 200px;
        }
        
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            cursor: pointer;
        }
        
        .flip-card-front {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }
        
        .flip-card-back {
            background: white;
            color: #374151;
            border: 2px solid #dc2626;
            transform: rotateY(180deg);
        }

        /* Activity 3: Chaotic Protocol Styles */
        .drag-item {
            cursor: grab;
            transition: all 0.2s ease;
            user-select: none;
            touch-action: none; /* Crucial for touch compatibility */
        }
        
        .drag-item.dropped {
            opacity: 0.3;
            cursor: default;
        }

        .drop-zone-pcr {
            height: 300px;
            border: 4px solid #374151;
            background-color: #f9fafb;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            overflow: hidden;
            background: none; /* Start with no liquid */
        }
        
        .drop-zone-pcr.drag-over {
            border-color: #3b82f6; /* Blue border on hover */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            transform: scale(1.02);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-full bg-gray-50 font-sans">
    <header class="bg-white shadow-sm border-b border-gray-100">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="index.html" class="flex items-center space-x-2">
                    <div class="w-8 h-8 custom-red rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">iG</span>
                    </div>
                    <span class="text-gray-900 font-medium">Le Grand Jamboree</span>
                </a>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="custom-red text-white px-3 py-1 rounded-md text-sm font-medium hover:opacity-90 transition duration-150 flex items-center space-x-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                        <span>Menu</span>
                    </a>
                    
                    <div class="text-right">
                        <div class="text-xl font-bold text-gray-900" id="score">0 / 100 pts</div>
                        <div class="text-sm text-gray-600">üåô Sleep Hours: <span id="sleep-hours">8h</span></div>
                    </div>
                    <div class="w-32 bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="progress-bar bg-red-600 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                Level 3: All-Nighter Lab üå°Ô∏è
            </h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                It's 2 AM and your project needs the final data. Master lab techniques and French terms related to **Urgence** and **Protocol**!
            </p>
        </div>

        <section id="activity-1" class="activity-section mb-12">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">üß© 1. Flashcards: Lab Vocabulary</h2>
                <p class="text-gray-600 mb-6">Click all cards to continue. (You'll need these words for the next activity!)</p>
                
                <div class="grid md:grid-cols-4 gap-6" id="flashcards-container">
                    </div>
                
                <div id="flashcard-success" class="hidden mt-6 text-center">
                    <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg mb-4">
                        <span class="mr-2">‚úÖ</span>
                        Excellent! You have mastered the lab vocabulary.
                    </div>
                    <button onclick="completeActivity(1)" class="custom-red text-white px-6 py-2 rounded-lg hover:opacity-90 transition-opacity" disabled id="activity-1-complete">
                        Continue to the Chaotic Protocol ‚Üí
                    </button>
                </div>
            </div>
        </section>


        <section id="activity-3" class="activity-section mb-12 hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 fade-in">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üî¨ 2. Chaotic Protocol: The PCR!</h2>
                <p class="text-gray-600 mb-4">Add the 3 **Correct** reagents to the PCR tube. Drag a **Contaminant** and lose 4 hours of sleep!</p>
                
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-red-700 font-semibold">üåô Wrong choice = -4 hours of sleep!</p>
                    <p class="text-red-700 font-semibold">‚ö†Ô∏è Current Sleep Hours: <span id="current-sleep-hours">8h</span></p>
                </div>

                <div class="grid md:grid-cols-3 gap-8 items-start">
                    <div class="md:col-span-2">
                        <h3 class="font-semibold mb-4 text-gray-700">Reagents List (Reactifs):</h3>
                        <div class="grid grid-cols-2 gap-3" id="reactifs-container">
                            <div class="drag-item p-4 rounded-lg bg-blue-100 border border-blue-300 text-blue-800 hover:shadow-lg" draggable="true" data-type="correct">
                                <div class="font-semibold">ADN Polym√©rase</div>
                            </div>
                            <div class="drag-item p-4 rounded-lg bg-blue-100 border border-blue-300 text-blue-800 hover:shadow-lg" draggable="true" data-type="correct">
                                <div class="font-semibold">Amorce (Primer)</div>
                            </div>
                            <div class="drag-item p-4 rounded-lg bg-blue-100 border border-blue-300 text-blue-800 hover:shadow-lg" draggable="true" data-type="correct">
                                <div class="font-semibold">Matrice d'ADN</div>
                            </div>
                            <div class="drag-item p-4 rounded-lg bg-red-100 border border-red-300 text-red-800 hover:shadow-lg" draggable="true" data-type="contaminant">
                                <div class="font-semibold">Eau contamin√©e</div>
                            </div>
                            <div class="drag-item p-4 rounded-lg bg-red-100 border border-red-300 text-red-800 hover:shadow-lg" draggable="true" data-type="contaminant">
                                <div class="font-semibold">Acide (Acid)</div>
                            </div>
                            <div class="drag-item p-4 rounded-lg bg-red-100 border border-red-300 text-red-800 hover:shadow-lg" draggable="true" data-type="contaminant">
                                <div class="font-semibold">Prot√©ase</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-center">
                        <h3 class="font-semibold mb-4 text-gray-700">PCR Tube (Zone de d√©p√¥t):</h3>
                        <div id="pcr-tube-drop" class="drop-zone-pcr w-24 rounded-b-full rounded-t-lg shadow-xl" data-target="pcr-mix">
                            <div class="text-4xl text-gray-400">üß™</div>
                            <div class="text-lg font-bold text-gray-500 mt-2">PCR Tube</div>
                            <div id="tube-contents">0/3 Components</div>
                        </div>
                    </div>
                </div>
                
                <div id="protocole-success" class="hidden mt-6 text-center">
                    <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg mb-4">
                        <span class="mr-2">üéâ</span>
                        Protocol **R√©ussir**! You didn't lose any sleep!
                    </div>
                    <button id="activity-3-complete" class="custom-red text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity" onclick="completeActivity(3)" disabled>
                        ‚úì Finish the Level!
                    </button>
                </div>
            </div>
        </section>

        <section id="final-results" class="activity-section mb-8 bg-white rounded-lg p-6 shadow-md text-center hidden">
            <h2 class="text-3xl font-bold mb-4 text-green-600">üéâ Congratulations! You have <strong>surv√©cu</strong>!</h2>
            <p class="text-xl mb-4">The <strong>r√©sultat</strong> of your hard work is here: Mission accomplished on time!</p>
            <div class="custom-gold text-white p-6 rounded-lg mb-6">
                <div class="text-2xl font-bold mb-2" id="final-score">Final Score: 0/105</div>
                <div class="text-lg">üò¥ Final Sleep Hours: <span id="final-sleep-hours">8h</span></div>
                <div class="text-sm mt-2">You managed the <strong>Urgence</strong> and avoided <strong>Contamination</strong>.</div>
            </div>
            <a href="level4.html" class="custom-red text-white px-8 py-4 rounded-lg font-semibold text-lg hover:opacity-90 transition-opacity">
                üöÄ Proceed to Level 4: The Jamboree
            </a>
            </section>
    </main>

    <script>
        let currentActivity = 1;
        let score = 0;
        let sleepHours = 8;
        let flippedCards = new Set();
        let pcrComponents = 0;
        
        // Constants
        const CONTAMINATION_LOSS = -4; // P√©rdida de horas de sue√±o
        const DEFAULT_TUBE_HTML = '<div class="text-4xl text-gray-400">üß™</div><div class="text-lg font-bold text-gray-500 mt-2">PCR Tube</div><div id="tube-contents">0/3 Components</div>';
        
        // Data for Flashcards
        const flashcards = [
            { french: "Urgence", english: "Emergency / Urgence" },
            { french: "Protocole", english: "Protocol / Protocole" },
            { french: "R√©ussir", english: "To succeed / R√©ussir" },
            { french: "Contamination", english: "Contamination / Contamination" },
            { french: "R√©p√©ter", english: "To repeat / R√©p√©ter" },
            { french: "R√©sultat", english: "Result / R√©sultat" },
            { french: "Pipette", english: "Pipette / Pipette" },
            { french: "Centrifugeuse", english: "Centrifuge / Centrifugeuse" }
        ];

        // --- GAME FLOW FUNCTIONS ---

        function initGame() {
            generateFlashcards();
            initializeDragAndDrop(); 
            updateProgress();
            updateSleepHours(0);
            document.getElementById('score').textContent = `${score} / 100 pts`;
            document.getElementById('activity-1').classList.remove('hidden');
        }

        function generateFlashcards() {
            const container = document.getElementById('flashcards-container');
            container.innerHTML = '';
            
            flashcards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'flip-card';
                cardElement.innerHTML = `
                    <div class="flip-card-inner">
                        <div class="flip-card-front">
                            <div class="text-2xl font-bold mb-2">${card.french}</div>
                            <div class="text-sm opacity-80">Click to view</div>
                        </div>
                        <div class="flip-card-back">
                            <div>
                                <div class="text-lg font-semibold text-gray-800 mb-2">${card.english}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                cardElement.addEventListener('click', () => {
                    if (!cardElement.classList.contains('flipped')) {
                        cardElement.classList.add('flipped');
                        flippedCards.add(card.french);
                        checkFlashcardCompletion();
                    }
                });
                
                container.appendChild(cardElement);
            });
        }
        
        function checkFlashcardCompletion() {
            if (flippedCards.size === flashcards.length) {
                document.getElementById('flashcard-success').classList.remove('hidden');
                document.getElementById('activity-1-complete').disabled = false;
                document.getElementById('activity-1-complete').classList.add('pulse-success');
                updateScore(30);
            }
        }
        
        function completeActivity(activityNumber) {
            const currentSection = document.getElementById(`activity-${activityNumber}`);
            
            currentSection.classList.add('hidden');
            
            if (activityNumber === 1) {
                document.getElementById('activity-3').classList.remove('hidden');
                document.getElementById('activity-3').classList.add('fade-in');
                currentActivity = 2;
                updateProgress();
            } else if (activityNumber === 3) {
                // Chaotic Protocol -> Final Results
                showFinalResults();
                document.getElementById('final-results').classList.remove('hidden');
                document.getElementById('final-results').classList.add('fade-in');
                currentActivity = 3;
            }
        }

        function updateProgress() {
            const progress = Math.round(((currentActivity - 1) / 2) * 100);
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        // --- GAMIFICATION FUNCTIONS ---

        function updateScore(points) {
            score += points;
            document.getElementById('score').textContent = `${score} / 100 pts`;
        }

        function updateSleepHours(hoursChange) {
            sleepHours = Math.max(0, sleepHours + hoursChange); // Sleep can't go below 0
            
            const sleepElement = document.getElementById('sleep-hours');
            const currentHoursElement = document.getElementById('current-sleep-hours');

            sleepElement.textContent = `${sleepHours}h`;
            currentHoursElement.textContent = `${sleepHours}h`;

            if (sleepHours <= 4) {
                sleepElement.style.color = '#ef4444'; // Red
                currentHoursElement.style.color = '#ef4444'; 
                document.body.style.backgroundColor = '#fef2f2'; // Light red background for panic
            } else {
                 sleepElement.style.color = '#10b981'; // Green
                 currentHoursElement.style.color = '#10b981'; 
                 document.body.style.backgroundColor = '#f8fafc'; // Normal background
            }
        }
        
        function showFinalResults() {
            document.getElementById('final-score').textContent = `Final Score: ${score}/100`;
            document.getElementById('final-sleep-hours').textContent = `${sleepHours}h`;
        }
        
        // --- TOUCH & DRAG & DROP FUNCTIONS ---

        // Variables globales para el manejo de arrastre t√°ctil
        window._touch_drag_data = {
            element: null,
            type: null,
            name: null,
            clone: null,
        };

        function initializeDragAndDrop() {
            const reactifsContainer = document.getElementById('reactifs-container');
            const pcrTubeDrop = document.getElementById('pcr-tube-drop');
            
            // 1. Mouse Drag Events
            reactifsContainer.addEventListener('dragstart', (e) => {
                const item = e.target.closest('.drag-item');
                if (item && !item.classList.contains('dropped')) {
                    e.dataTransfer.setData('data-type', item.dataset.type);
                    e.dataTransfer.setData('text/plain', item.textContent.trim());
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            pcrTubeDrop.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                pcrTubeDrop.classList.add('drag-over');
            });

            pcrTubeDrop.addEventListener('dragleave', () => {
                pcrTubeDrop.classList.remove('drag-over');
            });

            pcrTubeDrop.addEventListener('drop', handleDrop);
            
            // 2. Touch Events (for mobile)
            document.querySelectorAll('.drag-item').forEach(item => {
                // Usar passive: false para que preventDefault funcione en touchmove
                item.addEventListener('touchstart', handleTouchStart, { passive: false });
                item.addEventListener('touchmove', handleTouchMove, { passive: false });
                item.addEventListener('touchend', handleTouchEnd);
            });
        }

        function handleDrop(e) {
            e.preventDefault();
            const pcrTubeDrop = document.getElementById('pcr-tube-drop');
            pcrTubeDrop.classList.remove('drag-over');
            
            // Determinar la fuente de los datos (rat√≥n o t√°ctil)
            const isTouch = !e.dataTransfer;
            
            const dataType = isTouch ? window._touch_drag_data.type : e.dataTransfer.getData('data-type');
            const reactifName = isTouch ? window._touch_drag_data.name : e.dataTransfer.getData('text/plain');
            
            const reactifsContainer = document.getElementById('reactifs-container');
            const draggedElement = Array.from(reactifsContainer.querySelectorAll('.drag-item')).find(el => el.textContent.trim() === reactifName);

            if (!draggedElement || draggedElement.classList.contains('dropped')) return;

            if (dataType === 'contaminant') {
                // L√≥gica de Contaminaci√≥n
                const tubeDrop = document.getElementById('pcr-tube-drop');
                tubeDrop.style.backgroundColor = '#fef2f2';
                tubeDrop.style.background = 'none';
                tubeDrop.innerHTML = '<div class="text-4xl text-red-600">‚ùå</div><div class="text-lg font-bold text-red-700 mt-2">CONTAMIN√â! You must <strong>R√©p√©ter</strong>!</div>';
                
                updateSleepHours(CONTAMINATION_LOSS);
                
                setTimeout(() => {
                    resetActivity3();
                }, 1500);
                return;
            }

            if (dataType === 'correct') {
                // L√≥gica de Soltar Correcto
                pcrComponents++;
                document.getElementById('tube-contents').textContent = `${pcrComponents}/3 Components`;
                
                draggedElement.classList.add('dropped');
                draggedElement.draggable = false;
                
                // Efecto de llenado de l√≠quido (azul)
                const newHeight = 33 * pcrComponents;
                pcrTubeDrop.style.background = `linear-gradient(to top, #60a5fa ${newHeight}%, #f9fafb ${newHeight}%)`;

                if (pcrComponents === 3) {
                    document.getElementById('protocole-success').classList.remove('hidden');
                    document.getElementById('activity-3-complete').disabled = false;
                    pcrTubeDrop.innerHTML = '<div class="text-4xl text-green-600">‚úÖ</div><div class="text-lg font-bold text-green-700 mt-2">PROTOCOL <strong>R√âUSSIR</strong>!</div>';
                    updateScore(40);
                }
            }
        }


        function handleTouchStart(e) {
            if (e.target.closest('.dropped')) return;
            
            const originalItem = e.target.closest('.drag-item');
            if (!originalItem) return;

            // 1. Crear un clon para arrastrar
            const clone = originalItem.cloneNode(true);
            clone.classList.add('fixed', 'opacity-75', 'shadow-2xl', 'z-50', 'bg-blue-200', 'border-blue-400');
            clone.style.width = `${originalItem.offsetWidth}px`;
            clone.style.height = `${originalItem.offsetHeight}px`;
            clone.style.transition = 'none';
            
            // Posicionar el clon en la ubicaci√≥n inicial
            const rect = originalItem.getBoundingClientRect();
            clone.style.left = `${rect.left}px`;
            clone.style.top = `${rect.top}px`;
            
            document.body.appendChild(clone);

            // 2. Almacenar datos en la variable global
            window._touch_drag_data = {
                element: originalItem,
                type: originalItem.dataset.type,
                name: originalItem.textContent.trim(),
                clone: clone
            };
        }

        function handleTouchMove(e) {
            if (!window._touch_drag_data.clone) return;

            e.preventDefault(); // Previene el scroll del m√≥vil
            
            const touch = e.touches[0];
            const clone = window._touch_drag_data.clone;
            const pcrTubeDrop = document.getElementById('pcr-tube-drop');
            
            // Mover el clon con el dedo
            clone.style.left = `${touch.clientX - clone.offsetWidth / 2}px`;
            clone.style.top = `${touch.clientY - clone.offsetHeight / 2}px`;

            // L√≥gica de drag-over
            const dropRect = pcrTubeDrop.getBoundingClientRect();
            const isOverDropZone = touch.clientX > dropRect.left && 
                                   touch.clientX < dropRect.right &&
                                   touch.clientY > dropRect.top &&
                                   touch.clientY < dropRect.bottom;
                                   
            if (isOverDropZone) {
                pcrTubeDrop.classList.add('drag-over');
            } else {
                pcrTubeDrop.classList.remove('drag-over');
            }
        }

        function handleTouchEnd(e) {
            if (!window._touch_drag_data.clone) return;
            
            const clone = window._touch_drag_data.clone;
            const pcrTubeDrop = document.getElementById('pcr-tube-drop');

            const dropRect = pcrTubeDrop.getBoundingClientRect();
            const touch = e.changedTouches[0];
            
            // Verificar si la soltura ocurri√≥ dentro de la zona de ca√≠da
            const isDropped = touch.clientX > dropRect.left && 
                              touch.clientX < dropRect.right &&
                              touch.clientY > dropRect.top &&
                              touch.clientY < dropRect.bottom;

            if (isDropped) {
                // Simular el evento 'drop' usando datos t√°ctiles
                handleDrop({ 
                    preventDefault: () => {}, 
                    dataTransfer: null 
                });
            }

            // Limpieza y reseteo
            clone.remove();
            window._touch_drag_data = { element: null, type: null, name: null, clone: null };
            pcrTubeDrop.classList.remove('drag-over');
        }

        // --- MODIFIED RESET FUNCTION ---
        function resetActivity3() {
            pcrComponents = 0;
            const pcrTubeDrop = document.getElementById('pcr-tube-drop');
            
            // 1. Reset visual properties and force DOM overwrite using constant
            pcrTubeDrop.style.backgroundColor = '#f9fafb';
            pcrTubeDrop.style.background = 'none'; // Remove the blue fill
            
            // 2. Restore default tube content using the constant
            pcrTubeDrop.innerHTML = DEFAULT_TUBE_HTML;

            // 3. Make all draggable items available again
            document.querySelectorAll('#reactifs-container .drag-item').forEach(item => {
                item.classList.remove('dropped');
                item.draggable = true;
                item.style.opacity = '1';
            });
            
            // 4. Ensure success message is hidden and button disabled
            document.getElementById('protocole-success').classList.add('hidden');
            document.getElementById('activity-3-complete').disabled = true;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>