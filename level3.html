<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 3: All-Nighter Lab - The Final Race</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
            background-color: #f8fafc; /* Base color */
            transition: background-color 1.5s ease; /* Drastic color transition */
        }
        
        /* Base Colors (from level2.html) */
        .custom-red {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        .text-custom-red {
            color: #dc2626;
        }
        
        .custom-gold {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        /* Flashcard Styles */
        .flip-card {
            perspective: 1000px;
            width: 100%;
            height: 200px;
        }
        
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            cursor: pointer;
        }
        
        .flip-card-front {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }
        
        .flip-card-back {
            background: white;
            color: #374151;
            border: 2px solid #dc2626;
            transform: rotateY(180deg);
        }

        /* Activity Styles */
        .choice-button {
            transition: all 0.2s ease;
            user-select: none;
        }

        .choice-button.correct {
            background-color: #10b981;
            color: white;
        }

        .choice-button.incorrect {
            background-color: #ef4444;
            color: white;
        }

        .drag-item {
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
            /* Contaminant now uses the same color as the rest */
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            color: #b91c1c;
        }
        
        .drop-zone {
            border: 2px dashed #d1d5db;
            min-height: 120px;
            background-color: #f9fafb;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #f59e0b; 
            background-color: #fffbeb;
        }

        /* Background Color Transitions (More Drastic) */
        .bg-calme { background-color: #dbeafe; } /* Azul suave (Calmado) - Sin cambios */
        .bg-pression { background-color: #fca5a5; } /* Rojo intermedio (Antes Amarillo 200, ahora Red 300) */
        .bg-panique { background-color: #ef4444; } /* Rojo fuerte (Antes Red 200, ahora Red 500) */
        .bg-final-panique { background-color: #b91c1c; } /* Rojo muy oscuro/intenso (Antes Red 400, ahora Red 700) */

        /* Sleep Hours Pulse */
        .sleep-pulse {
            animation: sleepPulse 0.5s ease-in-out;
        }
        
        @keyframes sleepPulse {
            0% { transform: scale(1); background-color: #f59e0b; }
            50% { transform: scale(1.1); background-color: #ef4444; }
            100% { transform: scale(1); background-color: #f59e0b; }
        }
        
        /* Mobile-specific adjustments for drop zone */
        #pcr-tube-drop { 
            touch-action: none; /* Helps with some mobile drag-and-drop issues */
        }
    </style>
</head>
<body class="min-h-full font-sans transition-all bg-calme" id="game-body">
    <header class="bg-white shadow-sm border-b border-gray-100 sticky top-0 z-10">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
               <a href="index.html" class="flex items-center space-x-1 sm:space-x-2">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center sm:w-16 sm:h-16">
                        <img src="FROG skippit RED.png" alt="igem barcelona-ub logo" class="w-full h-full object-cover p-2">
                    </div>
                    <span class="text-custom-red font-bold text-lg md:text-xl">MENU</span>
                </a>
                
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div class="text-right sm:text-left">
                        <div class="text-lg sm:text-xl font-bold text-gray-900" id="score">0 / 105 pts</div>
                        <div class="text-xs sm:text-sm text-gray-600">
                             <span class="hidden sm:inline">üò¥ Sleep Hours:</span> 
                             <span class="inline sm:hidden">üò¥:</span> 
                             <span id="sleep-hours" class="font-bold inline-flex items-center custom-gold text-white px-2 rounded-full">8h</span>
                        </div>
                    </div>
                    <div class="w-20 sm:w-32 bg-gray-200 rounded-full h-2 flex-shrink-0">
                        <div id="progress-bar" class="progress-bar bg-red-600 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                
            </div>
        </nav>
    </header>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                Level 3: All-Nighter Lab üî¨
            </h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                The Final Race: Solve the Wet Lab crises to <strong>survivre</strong>!
            </p>
        </div>

        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8" role="alert">
            <p class="font-bold">New Metric: Sleep Hours (üò¥)</p>
            <p class="text-sm">Every mistake you make costs you time, reducing your precious <strong>Sleep Hours</strong>. If you run out, you'll be too tired for the Jamboree! Don't <strong>√©chouer</strong>!</p>
        </div>

        <section id="activity-1" class="activity-section mb-12">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">üß© 1. Flashcards: Wet Lab Vocabulary</h2>
                <p class="text-gray-600 mb-6">Memorize these words. You will need them to <strong>survivre</strong> the lab crises!</p>
                
                <div class="grid md:grid-cols-4 gap-6" id="flashcards-container">
                    </div>
                
                <div id="flashcard-success" class="hidden mt-6 text-center">
                    <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg mb-4">
                        <span class="mr-2">‚úÖ</span>
                        Excellent! You mastered the panic vocabulary. (30 pts)
                    </div>
                    <button onclick="completeActivity(1)" class="custom-red text-white px-6 py-2 rounded-lg hover:opacity-90 transition-opacity" disabled id="activity-1-complete">
                        Start The Race Against Time ‚Üí
                    </button>
                </div>
            </div>
        </section>

        <section id="activity-2" class="activity-section mb-12 hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 fade-in" id="panique-container">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">‚è∞ 2. Panic Timeline: Resolve the Crisis</h2>
                <div class="text-center mb-6">
                    <div class="text-3xl font-bold text-custom-red mb-2" id="current-stage-title"></div>
                    <p class="text-lg text-gray-600 font-semibold" id="current-crisis-text"></p>
                </div>

                <div id="crisis-options" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    </div>
                
                <div id="crisis-feedback" class="mt-6 text-center hidden">
                    <p class="text-xl font-semibold" id="feedback-text"></p>
                </div>

                <div id="chronologie-success" class="hidden mt-6 text-center">
                    <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg mb-4">
                        <span class="mr-2">üéâ</span>
                        All timeline emergencies resolved! (35 pts)
                    </div>
                    <button onclick="completeActivity(2)" class="custom-red text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity" id="activity-2-complete">
                        ‚úì Continue to Chaotic Protocol
                    </button>
                </div>
            </div>
        </section>

        <section id="activity-3" class="activity-section mb-12 hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 fade-in">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">üß™ 3. Chaotic Protocol: The PCR of Hope</h2>
                <p class="text-gray-600 mb-4">Your last chance for a <strong>r√©sultat</strong>. Drag the 3 essential components into the PCR tube so you don't <strong>√©chouer</strong>!</p>
                
                <div class="flex flex-col-reverse md:flex-row items-center justify-center space-y-8 md:space-y-0 md:space-x-12">
                    
                    <div id="reactifs-container" class="grid grid-cols-2 gap-4 w-full md:w-1/2 order-2 md:order-1 mt-8 md:mt-0">
                        <div class="drag-item p-4 rounded-lg text-center" draggable="true" data-type="correct">
                            <span class="font-bold text-lg">V√©rifier</span> DNA
                        </div>
                        <div class="drag-item p-4 rounded-lg text-center" draggable="true" data-type="correct">
                            <span class="font-bold text-lg">Trouver</span> Primers
                        </div>
                        <div class="drag-item p-4 rounded-lg text-center" draggable="true" data-type="correct">
                            <span class="font-bold text-lg">R√©p√©ter</span> Buffer
                        </div>
                        <div class="drag-item p-4 rounded-lg text-center" draggable="true" data-type="contaminant">
                            <span class="font-bold text-lg">Contaminer</span> Orange Juice
                        </div>
                    </div>
                    
                    <div id="pcr-tube-drop" class="drop-zone p-6 rounded-lg w-full sm:w-48 h-48 sm:h-64 flex items-center justify-center text-center flex-col shadow-inner relative order-1 md:order-2">
                        <div class="text-4xl">üî¨</div>
                        <div class="font-semibold text-gray-700 mt-2">PCR Tube (3 Required)</div>
                        <div id="tube-contents" class="absolute bottom-0 w-full p-2 bg-gray-200 text-sm">0/3 Components</div>
                    </div>

                </div>
                
                <div id="protocole-success" class="hidden mt-6 text-center">
                    <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg mb-4">
                        <span class="mr-2">üéâ</span>
                        PCR will <strong>r√©ussir</strong>! (40 pts)
                    </div>
                    <button id="activity-3-complete" class="custom-red text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity" onclick="completeActivity(3)">
                        üéâ Complete Level!
                    </button>
                </div>
            </div>
        </section>

       <section id="final-results" class="activity-section mb-8 bg-white rounded-lg p-6 shadow-md text-center hidden">
            <h2 class="text-3xl font-bold mb-4 text-green-600">üéâ Congratulations! You have <strong>surv√©cu</strong>!</h2>
            <p class="text-xl mb-4">The <strong>r√©sultat</strong> of your hard work is here: Mission accomplished on time!</p>
            <div class="custom-gold text-white p-6 rounded-lg mb-6">
                <div class="text-2xl font-bold mb-2" id="final-score">Final Score: 0/105</div>
                <div class="text-lg">üò¥ Final Sleep Hours: <span id="final-sleep-hours">8h</span></div>
                <div class="text-sm mt-2">You managed the <strong>Urgence</strong> and avoided <strong>Contamination</strong>.</div>
            </div>
            <a href="level4.html" class="custom-red text-white px-8 py-4 rounded-lg font-semibold text-lg hover:opacity-90 transition-opacity">
                üöÄ Proceed to Level 4: Wiki Freeze
            </a>
            </section>
    </main>

    <script>
        // --- GLOBAL CONSTANTS ---
        const SLEEP_HOUR_LOSS = 0.5; // Half hour lost per mistake
        const CONTAMINATION_LOSS = 1.0; // 1 full hour lost for contamination
        const DEFAULT_TUBE_HTML = '<div class="text-4xl">üî¨</div><div class="font-semibold text-gray-700 mt-2">PCR Tube (3 Required)</div><div id="tube-contents" class="absolute bottom-0 w-full p-2 bg-gray-200 text-sm">0/3 Components</div>';

        // --- GLOBAL VARIABLES ---
        let currentActivity = 1;
        let score = 0;
        let sleepHours = 8; // Starting sleep hours
        let flippedCards = new Set();
        let currentCrisisIndex = 0;
        let pcrComponents = 0;
        
        // --- DATA ---
        
        const flashcards = [
            { french: "Analyser", english: "To analyze", example: "Il faut analyser les donn√©es." },
            { french: "R√©p√©ter", english: "To repeat", example: "L'exp√©rience a √©chou√©, il faut r√©p√©ter." },
            { french: "V√©rifier", english: "To check/verify", example: "V√©rifier le protocole pour ne pas √©chouer." },
            { french: "√âchouer", english: "To fail", example: "Pourquoi la PCR continue d'√©chouer?" },
            { french: "Se d√©p√™cher", english: "To hurry", example: "La deadline arrive! Se d√©p√™cher!" },
            { french: "Nettoyer", english: "To clean", example: "Nettoyer le liquide renvers√©." },
            { french: "Cacher", english: "To hide", example: "Il faut cacher les preuves de la pizza." },
            { french: "Trouver", english: "To find", example: "Impossible de trouver le bon tube." },
            { french: "Contaminer", english: "To contaminate", example: "Attention de ne pas contaminer le milieu." },
            { french: "Urgence", english: "Emergency", example: "La date limite approche, c'est une urgence!" },
            { french: "R√©sultat", english: "Result", example: "Ce r√©sultat de derni√®re minute change tout." },
            { french: "Survivre", english: "To survive", example: "Avec du caf√©, nous allons survivre." }
        ];

        const crises = [
            {
                stage: "Phase 1: One Month Left (Calm)",
                text: "CRISIS: The crucial experiment has <strong>√©chouer</strong>. The team is demoralized.",
                colorClass: "bg-calme",
                options: [
                    { word: "R√©p√©ter", correct: true, feedback: "Correct! We <strong>r√©p√©ter</strong> for a better <strong>r√©sultat</strong>." },
                    { word: "Cacher", correct: false, feedback: "Wrong! <strong>Cacher</strong> failure won't help. -0.5h Sleep!" },
                    { word: "Survivre", correct: false, feedback: "You can't just <strong>survivre</strong> without working! -0.5h Sleep!" },
                    { word: "Analyser", correct: false, feedback: "You can't <strong>Analyser</strong> what doesn't exist. -0.5h Sleep!" }
                ]
            },
            {
                stage: "Phase 2: Wiki Freeze J-3 (Pressure)",
                text: "CRISIS: The lab is closed for the holiday, but you need a key <strong>r√©sultat</strong>. You must be discreet!",
                colorClass: "bg-pression",
                options: [
                    { word: "Contaminer", correct: false, feedback: "Bad idea! You'll <strong>Contaminer</strong> everything! -0.5h Sleep!" },
                    { word: "Cacher", correct: true, feedback: "Yes! Stealth mode activated. <strong>Cacher</strong> and get out! <strong>Urgence</strong> solved." },
                    { word: "V√©rifier", correct: false, feedback: "Too slow! Security will <strong>Trouver</strong> you. -0.5h Sleep!" },
                    { word: "Se d√©p√™cher", correct: false, feedback: "Running is not discreet. -0.5h Sleep!" }
                ]
            },
            {
                stage: "Phase 3: Jamboree D-1 (Total Panic)",
                text: "CRISIS: Final data is on the machine! 10 minutes until the deadline. You must check if the <strong>r√©sultat</strong> is good!",
                colorClass: "bg-panique",
                options: [
                    { word: "Trouver", correct: false, feedback: "The data is here! Don't waste time trying to <strong>Trouver</strong> it. -0.5h Sleep!" },
                    { word: "Analyser", correct: true, feedback: "Yes! <strong>Analyser</strong> the <strong>r√©sultat</strong> is the crucial last step. Well done!" },
                    { word: "√âchouer", correct: false, feedback: "That's the failure mindset! -0.5h Sleep!" },
                    { word: "Nettoyer", correct: false, feedback: "Do you really have time to <strong>Nettoyer</strong> now?! It's the end of the world! -0.5h Sleep!" }
                ]
            },
            {
                stage: "Phase 4: Aftermath (Final Panic)",
                text: "CRISIS: A tube fell and there is dangerous liquid on the floor. <strong>Urgence</strong>!",
                colorClass: "bg-final-panique",
                options: [
                    { word: "Se d√©p√™cher", correct: false, feedback: "Running around won't help! -0.5h Sleep!" },
                    { word: "Analyser", correct: false, feedback: "Stop trying to <strong>Analyser</strong> the spill! -0.5h Sleep!" },
                    { word: "Nettoyer", correct: true, feedback: "Safety first! <strong>Nettoyer</strong> the spill is mandatory. Go!" },
                    { word: "√âchouer", correct: false, feedback: "This is not the time to give up! -0.5h Sleep!" }
                ]
            }
        ];
        
        // --- FUNCTIONS ---

        function initGame() {
            generateFlashcards();
            initializeDragAndDrop();
            updateScore(0);
            updateSleepHours(0); // Update display with initial hours
            updateProgress();
        }

        function updateSleepHours(loss = 0) {
            sleepHours = Math.max(0, sleepHours - loss);
            const hoursDisplay = document.getElementById('sleep-hours');
            
            hoursDisplay.textContent = `${sleepHours.toFixed(1)}h`;

            if (loss > 0) {
                hoursDisplay.classList.add('sleep-pulse');
                setTimeout(() => hoursDisplay.classList.remove('sleep-pulse'), 500);
            }
        }
        
        function generateFlashcards() {
            const container = document.getElementById('flashcards-container');
            container.innerHTML = '';
            flippedCards = new Set(); 

            flashcards.forEach((card) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'flip-card';
                cardElement.innerHTML = `
                    <div class="flip-card-inner">
                        <div class="flip-card-front">
                            <div class="text-2xl font-bold mb-2">${card.french}</div>
                            <div class="text-sm opacity-80">Click to see</div>
                        </div>
                        <div class="flip-card-back">
                            <div>
                                <div class="text-lg font-semibold text-gray-800 mb-2">${card.english}</div>
                                <div class="text-xs text-blue-600 italic mt-1">"${card.example}"</div>
                            </div>
                        </div>
                    </div>
                `;
                
                cardElement.addEventListener('click', () => {
                    if (!cardElement.classList.contains('flipped')) {
                        cardElement.classList.add('flipped');
                        flippedCards.add(card.french);
                        checkFlashcardCompletion();
                    }
                });
                
                container.appendChild(cardElement);
            });
        }
        
        function checkFlashcardCompletion() {
            if (flippedCards.size === flashcards.length) {
                document.getElementById('flashcard-success').classList.remove('hidden');
                document.getElementById('activity-1-complete').disabled = false;
                updateScore(30);
            }
        }
        
        function completeActivity(activityNumber) {
            const currentSection = document.getElementById(`activity-${activityNumber}`);
            
            currentSection.classList.add('hidden');
            
            if (activityNumber === 1) {
                document.getElementById('activity-2').classList.remove('hidden');
                document.getElementById('activity-2').classList.add('fade-in');
                currentActivity = 2;
                loadCrisis(0);
            } else if (activityNumber === 2) {
                document.getElementById('activity-3').classList.remove('hidden');
                document.getElementById('activity-3').classList.add('fade-in');
                currentActivity = 3;
                document.getElementById('game-body').classList.remove('bg-calme', 'bg-pression', 'bg-panique', 'bg-final-panique');
                document.getElementById('game-body').classList.add('bg-final-panique'); // Hold the highest stress color
            } else if (activityNumber === 3) {
                showFinalResults();
                document.getElementById('final-results').classList.remove('hidden');
                document.getElementById('final-results').classList.add('fade-in');
                currentActivity = 4;
                document.getElementById('game-body').style.backgroundColor = '#f8fafc'; // Reset background for completion
            }
            updateProgress();
        }

        function updateProgress() {
            const progress = Math.round(((currentActivity - 1) / 3) * 100);
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }
        
        function updateScore(points) {
            score += points;
            document.getElementById('score').textContent = `${score} / 105 pts`;
        }

        function showFinalResults() {
            document.getElementById('final-score').textContent = `Final Score: ${score}/105`;
            document.getElementById('final-sleep-hours').textContent = `${sleepHours.toFixed(1)}h`;
        }
        
        // --- ACTIVITY 2: PANIC TIMELINE ---
        
        function loadCrisis(index) {
            if (index >= crises.length) {
                document.getElementById('chronologie-success').classList.remove('hidden');
                updateScore(35);
                return;
            }

            const crisis = crises[index];
            document.getElementById('game-body').classList.remove('bg-calme', 'bg-pression', 'bg-panique', 'bg-final-panique');
            document.getElementById('game-body').classList.add(crisis.colorClass);

            document.getElementById('current-stage-title').textContent = crisis.stage;
            document.getElementById('current-crisis-text').innerHTML = crisis.text; // Use innerHTML for <strong> tags

            const optionsContainer = document.getElementById('crisis-options');
            optionsContainer.innerHTML = '';
            
            const mixedOptions = crisis.options.sort(() => Math.random() - 0.5);

            mixedOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'choice-button bg-gray-200 text-gray-800 p-4 rounded-lg font-semibold hover:bg-gray-300 transition-colors';
                button.textContent = option.word;
                button.setAttribute('data-correct', option.correct);
                button.setAttribute('data-feedback', option.feedback);
                button.onclick = () => handleCrisisChoice(button, option.correct);
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('crisis-feedback').classList.add('hidden');
            document.getElementById('feedback-text').textContent = '';
            
            currentCrisisIndex = index;
        }

        function handleCrisisChoice(selectedButton, isCorrect) {
            const options = document.getElementById('crisis-options').querySelectorAll('button');
            options.forEach(btn => btn.disabled = true);

            const feedbackText = document.getElementById('feedback-text');
            feedbackText.innerHTML = selectedButton.dataset.feedback; // Use innerHTML for <strong> tags
            document.getElementById('crisis-feedback').classList.remove('hidden');

            if (isCorrect) {
                selectedButton.classList.add('correct');
                feedbackText.classList.remove('text-red-700');
                feedbackText.classList.add('text-green-700');
                
                setTimeout(() => loadCrisis(currentCrisisIndex + 1), 1500);
            } else {
                selectedButton.classList.add('incorrect');
                updateSleepHours(SLEEP_HOUR_LOSS);
                feedbackText.classList.remove('text-green-700');
                feedbackText.classList.add('text-red-700');
                
                // ELIMINADA LA L√ìGICA PARA MARCAR EL BOT√ìN CORRECTO EN VERDE AL FALLAR
                
                setTimeout(() => {
                    loadCrisis(currentCrisisIndex); // Repeat the same crisis
                }, 2000);
            }
        }

        // --- TOUCH & DRAG & DROP FUNCTIONS ---
// Guardamos el elemento arrastrado real (tanto para mouse como touch)
let currentDraggedElement = null;

function initializeDragAndDrop() {
    const reactifsContainer = document.getElementById('reactifs-container');
    const pcrTubeDrop = document.getElementById('pcr-tube-drop');

    // ‚úÖ Mouse Events
    reactifsContainer.addEventListener('dragstart', (e) => {
        const item = e.target.closest('.drag-item');
        if (item && !item.classList.contains('dropped')) {
            currentDraggedElement = item;
            e.dataTransfer.setData('type', item.dataset.type);
        }
    });

    pcrTubeDrop.addEventListener('dragover', (e) => {
        e.preventDefault();
        pcrTubeDrop.classList.add('drag-over');
    });

    pcrTubeDrop.addEventListener('dragleave', () => {
        pcrTubeDrop.classList.remove('drag-over');
    });

    pcrTubeDrop.addEventListener('drop', (e) => {
        e.preventDefault();
        handleDrop(currentDraggedElement);
        currentDraggedElement = null;
    });

    // ‚úÖ Touch Events (m√≥vil)
    document.querySelectorAll('.drag-item').forEach(item => {
        item.addEventListener('touchstart', (e) => {
            if (item.classList.contains('dropped')) return;
            currentDraggedElement = item;
        });

        item.addEventListener('touchend', (e) => {
            const dropRect = pcrTubeDrop.getBoundingClientRect();
            const t = e.changedTouches[0];

            const droppedInside =
                t.clientX > dropRect.left &&
                t.clientX < dropRect.right &&
                t.clientY > dropRect.top &&
                t.clientY < dropRect.bottom;

            if (droppedInside) {
                handleDrop(currentDraggedElement);
            }

            currentDraggedElement = null;
        });
    });
}

function handleDrop(item) {
    if (!item || item.classList.contains('dropped')) return;

    const type = item.dataset.type;
    const pcrTubeDrop = document.getElementById('pcr-tube-drop');

    if (type === "contaminant") {
        pcrTubeDrop.style.backgroundColor = '#fef2f2';
        pcrTubeDrop.innerHTML = `
            <div class="text-4xl text-red-600">‚ùå</div>
            <div class="text-lg font-bold text-red-700 mt-2">
                CONTAMIN√â! <strong>R√©p√©ter</strong>!
            </div>`;

        updateSleepHours(-4);

        setTimeout(() => resetActivity3(), 1500);
        return;
    }

    if (type === "correct") {
        pcrComponents++;
        item.classList.add('dropped');
        item.draggable = false;
        item.style.opacity = 0.4;

        const liquidHeight = 33 * pcrComponents;
        pcrTubeDrop.style.background = `linear-gradient(to top, #60a5fa ${liquidHeight}%, #f9fafb ${liquidHeight}%)`;
        document.getElementById('tube-contents').textContent = `${pcrComponents}/3 Components`;

        if (pcrComponents === 3) {
            updateScore(40);
            document.getElementById('protocole-success').classList.remove('hidden');
            document.getElementById('activity-3-complete').disabled = false;
            pcrTubeDrop.innerHTML = `
                <div class="text-4xl text-green-600">‚úÖ</div>
                <div class="text-lg font-bold text-green-700 mt-2">
                    PROTOCOL <strong>R√âUSSIR</strong>!
                </div>`;
        }
    }
}

        // --- MODIFIED RESET FUNCTION ---
        function resetActivity3() {
            pcrComponents = 0;
            const pcrTubeDrop = document.getElementById('pcr-tube-drop');
            
            // 1. Reset visual properties and force DOM overwrite using constant
            pcrTubeDrop.style.backgroundColor = '#f9fafb';
            pcrTubeDrop.style.background = 'none'; // Remove the blue fill
            
            // 2. Restore default tube content using the constant
            pcrTubeDrop.innerHTML = DEFAULT_TUBE_HTML;

            // 3. Make all draggable items available again
            document.querySelectorAll('#reactifs-container .drag-item').forEach(item => {
                item.classList.remove('dropped');
                item.draggable = true;
            });
            
            // 4. Ensure success message is hidden
            document.getElementById('protocole-success').classList.add('hidden');
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>